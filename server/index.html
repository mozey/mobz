<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <link rel="icon" href="assets/favicon.ico">
    <title>mobz</title>
    <script>
        window.addEventListener("load", function (evt) {

            var output = document.getElementById("output");
            var ws;

            var coords = {
                mobz: "{{.Mobz}}",
                userId: "{{.UserID}}",
                latitude: "{{.Latitude}}",
                longitude: "{{.Longitude}}"
            };
            coords["userId"] = Number(coords["userId"]);
            coords["latitude"] = Number(coords["latitude"]);
            coords["longitude"] = Number(coords["longitude"]);

            var print = function (message) {
                var d = document.createElement("div");
                d.innerHTML = message;
                output.appendChild(d);
            };

            document.getElementById("open").onclick = function (evt) {
                if (ws) {
                    return false;
                }
                var websocketUrl = "{{.WebSocketUrl}}";
                ws = new WebSocket(websocketUrl);
                print(websocketUrl);
                ws.onopen = function (evt) {
                    print("OPEN");
                };
                ws.onclose = function (evt) {
                    print("CLOSE");
                    ws = null;
                };
                ws.onmessage = function (evt) {
                    print("RESPONSE: " + evt.data);
                };
                ws.onerror = function (evt) {
                    print("ERROR: " + evt.data);
                };
                return false;
            };

            var second = 1000;
            function getLocation(callback) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    console.info("position", position);
                    coords.success = true;
                    coords.latitude = position.coords.latitude;
                    coords.longitude = position.coords.longitude;
                    console.info(JSON.stringify(coords, null, 2));
                    var message = JSON.stringify(coords);
                    callback(message);
                }, function(error) {
                    print("GEOLOCATION ERR: " + error.code + " " + error.message);
                    coords.success = false;
                    var message = JSON.stringify(coords);
                    callback(message);
                }, {
                    timeout: 5 * second,
                    enableHighAccuracy: false
//                    maximumAge: 60000,
                });
            }

            function sendLocation(message) {
                print("SEND: " + message);
                ws.send(message);
            }

            document.getElementById("send").onclick = function (evt) {
                if (!ws) {
                    print("Socket error");
                    return false;
                }
                getLocation(sendLocation);
                return false;
            };

            document.getElementById("close").onclick = function (evt) {
                if (!ws) {
                    return false;
                }
                ws.close();
                return false;
            };

            var updateLoop = false;
            function update() {
                getLocation(function(message) {
                    sendLocation(message);
                    if (updateLoop) {
                        setTimeout(update, second);
                    }
                });
            }

            document.getElementById("update").onclick = function (evt) {
                updateLoop = true;
                update();
                return false;
            };

            document.getElementById("stop").onclick = function (evt) {
                updateLoop = false;
                return false;
            };

            document.getElementById("info").onclick = function (evt) {
                alert(JSON.stringify(coords));
                return false;
            };

        });
    </script>
</head>
<body>
<div>
    <label for=mobz>mobz</label>
    <input id="mobz" type="text" style="width: 250px" value="">
</div>
<div><a id="open" href="javascript:">open socket</a></div>
<div><a id="close" href="javascript:">close socket</a></div>
<div><a id="send" href="javascript:">send location</a></div>
<div><a id="update" href="javascript:">update location</a></div>
<div><a id="stop" href="javascript:">stop updating</a></div>
<div><a id="info" href="javascript:">info</a></div>
<br>
<div id="output"></div>
</body>
</html>


